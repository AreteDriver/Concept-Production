name: CI

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-packages:
    name: Test Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pydantic
      
      - name: Run unit tests
        run: |
          cd tests/unit
          pytest -v --cov=../../packages --cov-report=xml
      
      - name: Run integration tests
        run: |
          cd tests/integration
          pytest -v
  
  test-orchestrator-api:
    name: Test Orchestrator API
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/orchestrator-api/requirements.txt
          pip install pytest httpx
      
      - name: Test API imports
        run: |
          cd apps/orchestrator-api
          python -c "import main; print('API imports OK')"
  
  test-cv-service:
    name: Test CV Service
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/cv-service/requirements.txt
          pip install pytest httpx
      
      - name: Test CV service imports
        run: |
          cd apps/cv-service
          python -c "import main; print('CV service imports OK')"
  
  test-device-io:
    name: Test Device I/O Service
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/device-io/requirements.txt
          pip install pytest httpx
      
      - name: Test Device I/O imports
        run: |
          cd apps/device-io
          python -c "import main; print('Device I/O imports OK')"
  
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort
      
      - name: Check code formatting with black
        run: |
          black --check packages/ apps/ tests/ || true
      
      - name: Check imports with isort
        run: |
          isort --check-only packages/ apps/ tests/ || true
      
      - name: Lint with flake8
        run: |
          flake8 packages/ apps/ tests/ --max-line-length=120 --extend-ignore=E203,W503 || true
  
  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PyYAML
        run: pip install pyyaml
      
      - name: Validate YAML files
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path
          
          errors = []
          for yaml_file in Path('docs').rglob('*.yaml'):
              try:
                  with open(yaml_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {yaml_file}')
              except Exception as e:
                  errors.append(f'✗ {yaml_file}: {e}')
                  
          if errors:
              print('\\nErrors found:')
              for error in errors:
                  print(error)
              sys.exit(1)
          else:
              print('\\nAll YAML files valid!')
          "
